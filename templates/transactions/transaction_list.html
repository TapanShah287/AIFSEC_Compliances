{% extends "base.html" %}
{% block title %}All Transactions{% endblock %}

{% block content %}
<div class="flex flex-wrap justify-between items-center mb-6 gap-4">
    <h1 class="text-2xl font-semibold text-slate-800">All Transactions</h1>
    
    <div class="flex items-center gap-2">
        <form id="add-txn-form" class="flex flex-wrap items-center gap-2" onsubmit="return false;">
            <select id="fund-select" class="border rounded-md px-2 py-2 text-sm">
                {% for f in funds %}
                    <option value="{{ f.pk }}">{{ f.name }}</option>
                {% endfor %}
            </select>
            
            <!-- Investment Transaction Buttons -->
            <a class="px-3 py-2 text-sm bg-indigo-600 text-white rounded-md font-semibold hover:bg-indigo-700 transition-colors" href="#" onclick="
                var fid=document.getElementById('fund-select').value;
                if(fid){ this.href='{% url 'transactions:add_purchase' 0 %}'.replace('/0/','/'+fid+'/'); window.location.href=this.href; }">Add Purchase</a>
            <a class="px-3 py-2 text-sm bg-emerald-600 text-white rounded-md font-semibold hover:bg-emerald-700 transition-colors" href="#" onclick="
                var fid=document.getElementById('fund-select').value;
                if(fid){ this.href='{% url 'transactions:add_redemption' 0 %}'.replace('/0/','/'+fid+'/'); window.location.href=this.href; }">Add Redemption</a>
            
            <!-- Investor Transaction Buttons (NEW) -->
            <a class="px-3 py-2 text-sm bg-sky-600 text-white rounded-md font-semibold hover:bg-sky-700 transition-colors" href="#" onclick="
                var fid=document.getElementById('fund-select').value;
                if(fid){ this.href='{% url 'transactions:add_drawdown' 0 %}'.replace('/0/','/'+fid+'/'); window.location.href=this.href; }">Add Drawdown</a>
            <a class="px-3 py-2 text-sm bg-amber-600 text-white rounded-md font-semibold hover:bg-amber-700 transition-colors" href="#" onclick="
                var fid=document.getElementById('fund-select').value;
                if(fid){ this.href='{% url 'transactions:add_distribution' 0 %}'.replace('/0/','/'+fid+'/'); window.location.href=this.href; }">Add Distribution</a>
        </form>
    </div>
</div>

<div class="bg-white shadow-lg rounded-xl overflow-hidden border border-slate-200">
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-100 text-slate-700 uppercase text-xs">
        <tr>
          <th class="px-4 py-3 text-left">Date</th>
          <th class="px-4 py-3 text-left">Type</th>
          <th class="px-4 py-3 text-left">Fund</th>
          <th class="px-4 py-3 text-left">Company / Investor</th>
          <th class="px-4 py-3 text-right">Quantity / Amount</th>
          <th class="px-4 py-3 text-right">Rate (₹)</th>
          <th class="px-4 py-3 text-right">Cash Flow (₹)</th>
          <th class="px-4 py-3 text-right">Capital Gain / (Loss) (₹)</th>
          <th class="px-4 py-3 text-center">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-200">
        {% for txn in transactions %}
        <tr class="hover:bg-slate-50">
          <td class="px-4 py-3 whitespace-nowrap">{{ txn.date|date:"d M Y" }}</td>
          <td class="px-4 py-3 whitespace-nowrap">
            {% if txn.type == 'Purchase' %}
              <span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-medium">Purchase</span>
            {% elif txn.type == 'Redemption' %}
              <span class="px-2 py-1 bg-rose-100 text-rose-700 rounded-full text-xs font-medium">Redemption</span>
            {% elif txn.type == 'Drawdown' %}
              <span class="px-2 py-1 bg-sky-100 text-sky-700 rounded-full text-xs font-medium">Drawdown</span>
            {% elif txn.type == 'Distribution' %}
              <span class="px-2 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-medium">Distribution</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 font-medium text-slate-800">{{ txn.fund__name }}</td>
          <td class="px-4 py-3 text-slate-600">{{ txn.investee_company__name|default:txn.investor__name }}</td>
          <td class="px-4 py-3 text-right text-slate-600">{{ txn.quantity|floatformat:2|default:txn.amount|floatformat:2 }}</td>
          <td class="px-4 py-3 text-right text-slate-600">{% if txn.rate %}₹{{ txn.rate|floatformat:2 }}{% else %}—{% endif %}</td>
          <td class="px-4 py-3 text-right font-medium">
            {% if txn.type == 'Purchase' or txn.type == 'Distribution' %}
              <span class="text-rose-600">-₹{{ txn.amount|floatformat:2 }}</span>
            {% else %}
              <span class="text-emerald-600">+₹{{ txn.amount|floatformat:2 }}</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 text-right font-mono">
            {% if txn.type == 'Redemption' %}
              {% if txn.capital_gain >= 0 %}
                <span class="text-emerald-600">₹{{ txn.capital_gain|floatformat:2 }}</span>
              {% else %}
                <span class="text-rose-600">(₹{{ txn.capital_gain|floatformat:"-2" }})</span>
              {% endif %}
            {% else %}
              <span class="text-slate-400">—</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 text-center">
            {% if txn.model_name == 'purchase' %}
              <a href="{% url 'transactions:purchase_delete' txn.pk %}" class="text-rose-600 hover:text-rose-800 hover:underline text-xs font-medium">Delete</a>
            {% elif txn.model_name == 'redemption' %}
              <a href="{% url 'transactions:redemption_delete' txn.pk %}" class="text-rose-600 hover:text-rose-800 hover:underline text-xs font-medium">Delete</a>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="9" class="px-4 py-8 text-center text-slate-500">No transactions found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
