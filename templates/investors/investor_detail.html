{% extends "base.html" %}

{% block title %}Investor - {{ investor.name }}{% endblock %}

{% block content %}
<!-- 2025 COMPLIANCE ALERTS BANNER -->
{% if compliance_alerts %}
<div class="mb-8 space-y-3">
    {% for alert in compliance_alerts %}
    <div class="flex items-center p-4 rounded-xl border {% if alert.level == 'danger' %}bg-rose-50 border-rose-100 text-rose-700{% elif alert.level == 'warning' %}bg-amber-50 border-amber-100 text-amber-700{% else %}bg-blue-50 border-blue-100 text-blue-700{% endif %}">
        <i class="bi {% if alert.level == 'danger' %}bi-exclamation-octagon-fill{% elif alert.level == 'warning' %}bi-exclamation-triangle-fill{% else %}bi-info-circle-fill{% endif %} text-xl mr-3"></i>
        <span class="font-bold text-sm">{{ alert.message }}</span>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Header & Scale Switcher -->
<div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-6">
    <div class="flex items-center gap-5">
        <div class="w-16 h-16 bg-white rounded-2xl shadow-sm border border-slate-100 flex items-center justify-center text-primary text-3xl">
            <i class="bi bi-person-badge"></i>
        </div>
        <div>
            <div class="flex items-center gap-3">
                <h1 class="text-3xl font-bold text-dark tracking-tight">{{ investor.name }}</h1>
                {% if investor.kyc_status == 'VERIFIED' %}
                    <i class="bi bi-patch-check-fill text-primary text-2xl" title="Verified"></i>
                {% endif %}
            </div>
            <div class="flex items-center gap-2 mt-1">
                <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-slate-100 text-slate-600">
                    {{ investor.get_investor_type_display }}
                </span>
                <!-- Accreditation Badge -->
                <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider 
                    {% if investor.accreditation_status == 'VALID' %}bg-emerald-100 text-emerald-700
                    {% elif investor.accreditation_status == 'EXPIRED' %}bg-rose-100 text-rose-700
                    {% else %}bg-slate-100 text-slate-500{% endif %}">
                    Accreditation: {{ investor.get_accreditation_status_display }}
                </span>
                <span class="text-secondary font-medium text-sm">• PAN: {{ investor.pan|upper }}</span>
            </div>
        </div>
    </div>
    
    <div class="bg-white p-1 rounded-xl shadow-sm border border-slate-200 inline-flex text-[10px] font-black uppercase tracking-widest overflow-hidden">
        <a href="?denom=raw" class="px-3 py-2 rounded-lg transition-all {% if denom == 'raw' or not denom %}bg-dark text-white shadow-sm{% else %}text-secondary hover:text-dark{% endif %}">INR</a>
        <a href="?denom=cr" class="px-3 py-2 rounded-lg transition-all {% if denom == 'cr' %}bg-primary text-white shadow-sm{% else %}text-secondary hover:text-dark{% endif %}">Crores</a>
        <a href="?denom=m" class="px-3 py-2 rounded-lg transition-all {% if denom == 'm' %}bg-indigo-600 text-white shadow-sm{% else %}text-secondary hover:text-dark{% endif %}">Millions</a>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <!-- Left Column: Metrics and Portfolio -->
    <div class="lg:col-span-2 space-y-8">
        <!-- Financial Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-secondary text-[10px] font-bold uppercase tracking-widest mb-2">Total Committed</p>
                <h3 class="text-xl font-black text-dark">₹{{ total_committed|floatformat:2 }}<span class="text-[10px] text-slate-400 ml-1">{{ suffix }}</span></h3>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-secondary text-[10px] font-bold uppercase tracking-widest mb-2">Capital Drawn</p>
                <h3 class="text-xl font-black text-dark">₹{{ total_contributed|floatformat:2 }}<span class="text-[10px] text-slate-400 ml-1">{{ suffix }}</span></h3>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-secondary text-[10px] font-bold uppercase tracking-widest mb-2">Uncalled Capital</p>
                <h3 class="text-xl font-black text-primary">₹{{ uncalled_capital|floatformat:2 }}<span class="text-[10px] text-slate-400 ml-1">{{ suffix }}</span></h3>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-secondary text-[10px] font-bold uppercase tracking-widest mb-2">Total Distributed</p>
                <h3 class="text-xl font-black text-green-600">₹{{ total_distributed|floatformat:2 }}<span class="text-[10px] text-slate-400 ml-1">{{ suffix }}</span></h3>
            </div>
        </div>

        <!-- Portfolio Holdings -->
        <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="p-6 border-b border-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-dark">Investment Portfolio</h3>
                <a href="{% url 'investors:add_commitment' investor.pk %}" class="text-primary text-xs font-bold hover:underline">+ Add Commitment</a>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50/50 text-[10px] uppercase font-bold text-secondary">
                        <tr>
                            <th class="px-6 py-4">Fund Scheme</th>
                            <th class="px-6 py-4 text-right">Commitment</th>
                            <th class="px-6 py-4 text-right">Date</th>
                            <th class="px-6 py-4 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50">
                        {% for comm in commitments %}
                        <tr class="hover:bg-slate-50/50 transition-colors">
                            <td class="px-6 py-4">
                                <div class="font-bold text-dark">{{ comm.fund.name }}</div>
                                <div class="text-[10px] text-slate-400">{{ comm.fund.get_category_display }}</div>
                            </td>
                            <td class="px-6 py-4 text-right font-medium">₹{{ comm.amount_committed|floatformat:2 }}</td>
                            <td class="px-6 py-4 text-right text-xs text-secondary">{{ comm.commitment_date|date:"M d, Y" }}</td>
                            <td class="px-6 py-4 text-right">
                                <a href="{% url 'funds:fund_detail' comm.fund.pk %}" class="text-slate-400 hover:text-primary"><i class="bi bi-arrow-right-circle"></i></a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="px-6 py-12 text-center text-secondary italic text-sm">No active fund commitments found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Right Column: Compliance and Documents -->
    <div class="space-y-6">
        <!-- Compliance & Demat Details -->
        <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100">
            <h3 class="font-bold text-lg text-dark mb-6">Compliance & Demat</h3>
            
            <div class="space-y-6">
                <!-- Demat Status -->
                <div>
                    <p class="text-[10px] font-bold text-secondary uppercase tracking-widest mb-2">Demat Account No.</p>
                    {% if investor.demat_account_no %}
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex items-center justify-between">
                            <span class="font-mono text-sm font-bold text-dark">{{ investor.demat_account_no }}</span>
                            <i class="bi bi-check-circle-fill text-emerald-500"></i>
                        </div>
                        <p class="text-[10px] text-secondary mt-2">DP ID: {{ investor.dp_id|default:"Not Provided" }}</p>
                    {% else %}
                        <div class="bg-rose-50 p-3 rounded-xl border border-rose-100 flex items-center justify-between">
                            <span class="text-sm font-bold text-rose-600 italic">Details Missing</span>
                            <i class="bi bi-x-circle-fill text-rose-500"></i>
                        </div>
                    {% endif %}
                </div>

                <!-- Accreditation -->
                <div>
                    <p class="text-[10px] font-bold text-secondary uppercase tracking-widest mb-2">Accreditation Expiry</p>
                    <div class="flex items-center justify-between">
                        <span class="font-bold text-sm {% if investor.accreditation_status == 'EXPIRED' %}text-rose-600{% else %}text-dark{% endif %}">
                            {{ investor.accreditation_expiry|date:"M d, Y"|default:"No Date Set" }}
                        </span>
                        {% if investor.accreditation_status == 'VALID' %}
                            <span class="text-[10px] font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded">ACTIVE</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Operations -->
        <div class="bg-slate-900 rounded-3xl p-8 text-white">
            <h3 class="font-bold text-lg mb-4">Quick Actions</h3>
            <div class="space-y-3">
                <a href="{% url 'investors:add_commitment' investor.pk %}" class="flex items-center justify-between w-full p-3 bg-white/5 rounded-xl hover:bg-white/10 transition border border-white/10 group">
                    <span class="text-xs font-bold uppercase tracking-wider">New Commitment</span>
                    <i class="bi bi-plus-circle text-white/40 group-hover:text-primary transition"></i>
                </a>
                <!-- These usually link to fund-specific transaction flows -->
                <a href="{% url 'funds:portal-funds' %}" class="flex items-center justify-between w-full p-3 bg-white/5 rounded-xl hover:bg-white/10 transition border border-white/10 group">
                    <span class="text-xs font-bold uppercase tracking-wider">Log Drawdown</span>
                    <i class="bi bi-arrow-down-left text-white/40 group-hover:text-primary transition"></i>
                </a>
            </div>
        </div>

        <!-- Document Vault -->
        <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg text-dark">Document Vault</h3>
                <i class="bi bi-folder2-open text-primary"></i>
            </div>
            <div class="space-y-3">
                {% for doc in documents %}
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl group transition-colors border border-slate-100">
                    <div class="flex items-center">
                        <i class="bi bi-file-earmark-pdf text-xl text-rose-500 mr-2"></i>
                        <div class="overflow-hidden">
                            <span class="text-[10px] font-black text-dark block leading-tight">{{ doc.get_doc_type_display }}</span>
                            <span class="text-[8px] text-secondary">{{ doc.uploaded_at|date:"M d, Y" }}</span>
                        </div>
                    </div>
                    <a href="{{ doc.file.url }}" class="w-7 h-7 flex items-center justify-center rounded-lg bg-white border border-slate-200 text-secondary hover:text-primary shadow-sm transition">
                        <i class="bi bi-download"></i>
                    </a>
                </div>
                {% empty %}
                <p class="text-xs text-secondary italic text-center py-4">No KYC or compliance files uploaded.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}