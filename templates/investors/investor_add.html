{% extends 'base.html' %}
{% block title %}Onboard Investor - AIF SEC{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="flex items-center gap-4 mb-8">
        <a href="{% url 'investors:portal-list' %}" class="w-12 h-12 flex items-center justify-center bg-white rounded-2xl shadow-sm border border-slate-100 text-slate-500 hover:text-indigo-600 transition-all">
            <i class="bi bi-arrow-left text-xl"></i>
        </a>
        <div>
            <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Onboard New Investor</h1>
            <p class="text-slate-500 text-sm">Create a master profile to begin the capital commitment process.</p>
        </div>
    </div>

    <div class="flex items-center gap-4 mb-8 px-2">
        <div class="flex items-center gap-2">
            <span class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xs font-bold">1</span>
            <span class="text-sm font-bold text-slate-900">Basic Info</span>
        </div>
        <div class="h-px w-12 bg-slate-200"></div>
        <div class="flex items-center gap-2 opacity-40">
            <span class="w-8 h-8 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center text-xs font-bold">2</span>
            <span class="text-sm font-medium text-slate-600">KYC Docs</span>
        </div>
        <div class="h-px w-12 bg-slate-200"></div>
        <div class="flex items-center gap-2 opacity-40">
            <span class="w-8 h-8 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center text-xs font-bold">3</span>
            <span class="text-sm font-medium text-slate-600">Commitment</span>
        </div>
    </div>

    {% if form.errors %}
    <div class="mb-8 p-5 bg-rose-50 border border-rose-100 rounded-2xl flex gap-4 items-start">
        <i class="bi bi-exclamation-circle-fill text-rose-500 mt-1"></i>
        <div class="text-rose-800 text-sm">
            <p class="font-bold mb-1">Validation Errors Found:</p>
            <ul class="list-disc ml-5 space-y-1">
                {% for field, errors in form.errors.items %}
                    <li><span class="font-semibold">{{ field|title }}:</span> {{ errors|striptags }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <form class="bg-white rounded-3xl shadow-sm border border-slate-200 p-10 overflow-hidden relative" id="investorForm" method="POST" novalidate>
        {% csrf_token %}
        <input type="hidden" name="kyc_status" value="PENDING">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-8">
            <div class="col-span-2">
                <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest mb-6 border-b border-slate-50 pb-2">Identification Details</h3>
            </div>

            <div class="col-span-2 md:col-span-1">
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Legal Name / Entity Name</label>
                <input name="name" id="id_name" class="w-full px-5 py-3 bg-slate-50 border border-slate-100 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:bg-white focus:border-indigo-500 outline-none transition-all font-medium text-slate-700" required placeholder="e.g. Reliance Strategic Investments" value="{{ form.name.value|default:'' }}">
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Investor Category</label>
                <select name="investor_type" id="id_investor_type" class="w-full px-5 py-3 bg-slate-50 border border-slate-100 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:bg-white focus:border-indigo-500 outline-none transition-all font-medium text-slate-700 cursor-pointer appearance-none" required>
                    <option value="INDIVIDUAL" {% if form.investor_type.value == 'INDIVIDUAL' %}selected{% endif %}>Individual</option>
                    <option value="HUF" {% if form.investor_type.value == 'HUF' %}selected{% endif %}>HUF</option>
                    <option value="CORPORATE" {% if form.investor_type.value == 'CORPORATE' %}selected{% endif %}>Corporate / Body Corporate</option>
                    <option value="TRUST" {% if form.investor_type.value == 'TRUST' %}selected{% endif %}>Trust / AIF</option>
                    <option value="LLP" {% if form.investor_type.value == 'LLP' %}selected{% endif %}>Limited Liability Partnership (LLP)</option>
                </select>
            </div>

<div class="col-span-2">
    <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest mt-4 mb-6 border-b border-slate-50 pb-2">Suitability & Compliance</h3>
</div>

<div>
    <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Accreditation Status</label>
    <select name="accreditation_status" id="id_accreditation_status" class="w-full px-5 py-3 bg-slate-50 border border-slate-100 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:bg-white focus:border-indigo-500 outline-none transition-all font-medium text-slate-700 cursor-pointer appearance-none" required>
        <option value="NOT_APPLICABLE" {% if form.accreditation_status.value == 'NOT_APPLICABLE' %}selected{% endif %}>Retail / Not Applicable</option>
        <option value="VALID" {% if form.accreditation_status.value == 'VALID' %}selected{% endif %}>Valid Accredited Investor (AI)</option>
        <option value="EXPIRED" {% if form.accreditation_status.value == 'EXPIRED' %}selected{% endif %}>Accreditation Expired</option>
    </select>
    <p class="text-[10px] text-slate-400 mt-2 italic">Required for CAT III and AI-only schemes.</p>
</div>

<div>
    <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Risk Appetite</label>
    <select name="risk_appetite" id="id_risk_appetite" class="w-full px-5 py-3 bg-slate-50 border border-slate-100 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:bg-white focus:border-indigo-500 outline-none transition-all font-medium text-slate-700 cursor-pointer appearance-none" required>
        <option value="LOW" {% if form.risk_appetite.value == 'LOW' %}selected{% endif %}>Low (Conservative)</option>
        <option value="MEDIUM" {% if form.risk_appetite.value == 'MEDIUM' %}selected{% endif %}>Medium (Balanced)</option>
        <option value="HIGH" {% if form.risk_appetite.value == 'HIGH' %}selected{% endif %}>High (Aggressive)</option>
        <option value="VERY_HIGH" {% if form.risk_appetite.value == 'VERY_HIGH' %}selected{% endif %}>Very High (Speculative)</option>
    </select>
</div>


            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">PAN / Tax ID</label>
                <input name="pan" id="id_pan" style="text-transform: uppercase;" class="w-full px-5 py-3 bg-slate-50 border border-slate-100 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:bg-white focus:border-indigo-500 outline-none transition-all font-mono tracking-widest text-slate-700" placeholder="ABCDE1234F" value="{{ form.pan.value|default:'' }}">
            </div>

            <div class="col-span-2">
                <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest mt-4 mb-6 border-b border-slate-50 pb-2">Communication Contacts</h3>
            </div>

            <div class="col-span-2 md:col-span-1">
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Primary Email Address</label>
                <input name="email" id="id_email" type="email" class="w-full px-5 py-3 bg-slate-50 border border-slate-100 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:bg-white focus:border-indigo-500 outline-none transition-all font-medium text-slate-700" placeholder="investor@example.com" value="{{ form.email.value|default:'' }}">
            </div>
            
            <div class="col-span-2 md:col-span-1">
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Phone Number (Optional)</label>
                <input name="phone" id="id_phone" type="text" class="w-full px-5 py-3 bg-slate-50 border border-slate-100 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:bg-white focus:border-indigo-500 outline-none transition-all font-medium text-slate-700" placeholder="+91" value="{{ form.phone.value|default:'' }}">
            </div>
        </div>

        <div id="form-error" class="mt-8 p-4 bg-rose-50 text-rose-700 border border-rose-100 rounded-xl hidden text-sm font-semibold flex items-center gap-3">
            <i class="bi bi-x-circle-fill"></i>
            <span id="error-text"></span>
        </div>

        <div class="mt-12 flex items-center justify-between pt-8 border-t border-slate-50">
            <p class="text-xs text-slate-400 max-w-sm italic">
                By creating this profile, you initiate the regulatory KYC workflow per SEBI/IFSCA guidelines.
            </p>
            <button type="submit" id="submit-btn" class="bg-indigo-600 text-white px-10 py-4 rounded-2xl font-black shadow-xl shadow-indigo-100 hover:bg-indigo-700 hover:-translate-y-1 transition-all flex items-center group">
                <span id="btn-text">Initialize Onboarding</span>
                <i class="bi bi-chevron-right ml-3 group-hover:translate-x-1 transition-transform" id="btn-icon"></i>
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const onboardForm = document.getElementById('investorForm');
        
        if (onboardForm) {
            onboardForm.addEventListener('submit', async function(e) {
                // Determine if we should attempt AJAX
                if (typeof api !== 'function') {
                    console.warn("API helper not found. Falling back to standard form submission.");
                    return true;
                }

                e.preventDefault(); 
                
                const btn = document.getElementById('submit-btn');
                const btnText = document.getElementById('btn-text');
                const errBox = document.getElementById('form-error');
                const errText = document.getElementById('error-text');
                
                // Loading State
                btn.disabled = true;
                btn.classList.add('opacity-70', 'cursor-not-allowed');
                btnText.innerText = "Processing Logic...";
                errBox.classList.add('hidden');

                const formData = new FormData(this);
                const payload = Object.fromEntries(formData.entries());
                payload.name = payload.name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
                payload.pan = payload.pan.toUpperCase();

                try {
                    const res = await api('/api/investors/', 'POST', payload);
                    // Redirect on success
                    window.location.href = `/portal/investors/${res.id}/`;
                    
                } catch (error) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-70', 'cursor-not-allowed');
                    btnText.innerText = "Initialize Onboarding";
                    
                    errText.innerText = error.message || "Something went wrong during submission.";
                    errBox.classList.remove('hidden');
                }
            });
        }
    });
</script>
{% endblock %}