{% extends "base.html" %}
{% block title %}Investor • AIF{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">Investor</h1>

<div id="investor-card" class="bg-white rounded-xl shadow p-6">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div>
      <div class="text-xs text-secondary">Name</div>
      <div id="inv-name" class="font-semibold text-lg">—</div>
    </div>
    <div>
      <div class="text-xs text-secondary">Email</div>
      <div id="inv-email" class="text-lg">—</div>
    </div>
    <div>
      <div class="text-xs text-secondary">KYC</div>
      <span id="inv-kyc" class="px-2 py-1 rounded text-xs bg-red-100 text-red-600">PENDING</span>
    </div>
  </div>

  <div class="mt-4 flex gap-3">
    <a href="{% url 'portal-investors' %}" class="px-3 py-2 bg-gray-200 rounded-lg">Back</a>
    <a id="btn-update-kyc" class="px-3 py-2 bg-slate-600 text-white rounded-lg cursor-pointer">Update KYC</a>
    <button id="btn-generate-kyc" class="px-3 py-2 bg-primary hover:bg-indigo-700 text-white rounded-lg">
      Generate KYC Form
    </button>
  </div>
</div>

<!-- Tabs -->
<div class="mt-8">
  <div class="border-b flex gap-6 text-sm">
    <button class="py-2 border-b-2 border-primary" data-tab="profile">Profile</button>
    <button class="py-2" data-tab="transactions">Transactions</button>
    <button class="py-2" data-tab="documents">Documents</button>
  </div>

  <!-- Profile -->
  <div id="tab-profile" class="py-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- left card -->
      <div class="bg-white rounded-xl border p-4">
        <h3 class="font-semibold mb-3">Investor</h3>
        <dl class="text-sm space-y-2">
          <div class="grid grid-cols-3 gap-2">
            <dt class="text-secondary">Name</dt><dd class="col-span-2" id="pf-name">—</dd>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <dt class="text-secondary">Email</dt><dd class="col-span-2" id="pf-email">—</dd>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <dt class="text-secondary">Phone</dt><dd class="col-span-2" id="pf-phone">—</dd>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <dt class="text-secondary">Type</dt><dd class="col-span-2" id="pf-type">—</dd>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <dt class="text-secondary">PAN</dt><dd class="col-span-2" id="pf-pan">—</dd>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <dt class="text-secondary">Address</dt><dd class="col-span-2" id="pf-address">—</dd>
          </div>
        </dl>
      </div>

      <!-- right card -->
      <div class="bg-white rounded-xl border p-4">
        <h3 class="font-semibold mb-3">KYC</h3>
        <dl class="text-sm space-y-2">
          <div class="grid grid-cols-3 gap-2">
            <dt class="text-secondary">Status</dt>
            <dd class="col-span-2">
              <span id="pf-kyc-badge" class="px-2 py-1 rounded text-xs bg-red-100 text-red-600">PENDING</span>
            </dd>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <dt class="text-secondary">Investor Type</dt><dd class="col-span-2" id="pf-kyc-type">—</dd>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <dt class="text-secondary">Date Completed</dt><dd class="col-span-2" id="pf-kyc-date">—</dd>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <dt class="text-secondary">Notes</dt><dd class="col-span-2" id="pf-kyc-notes">—</dd>
          </div>
        </dl>
      </div>
    </div>
  </div>

  <!-- Transactions -->
  <div id="tab-transactions" class="py-4 hidden">
    <div id="tx-empty" class="text-secondary text-sm">No transactions yet.</div>
    <table id="tx-table" class="hidden w-full text-sm">
      <thead>
        <tr>
          <th class="text-left py-1">Date</th>
          <th class="text-left">Type</th>
          <th class="text-right">Amount</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Documents -->
  <div id="tab-documents" class="py-4 hidden">
    <div class="bg-white rounded-xl border p-4 mb-4">
      <h3 class="font-semibold mb-3">Upload Document</h3>
      <form id="doc-form" class="flex flex-col md:flex-row gap-3 items-start">
        <select name="doc_type" class="border rounded-lg px-3 py-2" required>
          <option value="">— Select type —</option>
          <optgroup label="Individual">
            <option value="ACCOUNT_FORM">Account Form</option>
            <option value="PAN">PAN</option>
            <option value="AADHAR">AADHAR</option>
          </optgroup>
          <optgroup label="Non-Individual">
            <option value="MOA">MOA</option>
            <option value="AOA">AOA</option>
            <option value="COI">COI</option>
          </optgroup>
          <option value="OTHER">Other</option>
        </select>
        <input name="file" type="file" class="border rounded-lg px-3 py-2" required>
        <input name="notes" placeholder="Notes (optional)" class="border rounded-lg px-3 py-2 md:w-64">
        <button class="px-4 py-2 bg-primary text-white rounded-lg">Upload</button>
      </form>
      <div id="doc-error" class="text-danger text-sm mt-2 hidden"></div>
    </div>

    <div class="bg-white rounded-xl border">
      <table class="w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="text-left px-4 py-2">Type</th>
            <th class="text-left px-4 py-2">File</th>
            <th class="text-left px-4 py-2">Verified</th>
            <th class="text-left px-4 py-2">Notes</th>
            <th class="text-right px-4 py-2">Actions</th>
          </tr>
        </thead>
        <tbody id="doc-rows"></tbody>
      </table>
      <div id="docs-empty" class="text-secondary text-sm p-4 hidden">No documents yet.</div>
    </div>
  </div>
</div>

<!-- Update KYC Modal -->
<div id="kyc-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
  <div class="bg-white rounded-xl shadow p-6 w-full max-w-md">
    <h2 class="text-lg font-semibold mb-4">Update KYC</h2>
    <form id="kyc-form" class="space-y-3">
      <div class="flex items-center gap-2">
        <input id="kyc-completed" name="kyc_completed" type="checkbox" class="h-4 w-4">
        <label for="kyc-completed" class="text-sm text-secondary">KYC Completed</label>
      </div>

      <div>
        <label class="block text-sm text-secondary mb-1">Investor Type</label>
        <select name="investor_type" class="w-full border rounded-lg px-3 py-2" required>
          <option value="IND">Individual</option>
          <option value="NON-IND">Non-Individual</option>
        </select>
      </div>

      <div>
        <label class="block text-sm text-secondary mb-1">Date Completed</label>
        <input name="date_completed" type="date" class="w-full border rounded-lg px-3 py-2">
      </div>

      <div>
        <label class="block text-sm text-secondary mb-1">Notes (optional)</label>
        <textarea name="notes" class="w-full border rounded-lg px-3 py-2" rows="3"></textarea>
      </div>

      <div class="flex justify-end gap-2 pt-2">
        <button type="button" id="kyc-cancel" class="px-3 py-2 bg-gray-200 rounded-lg">Cancel</button>
        <button type="submit" class="px-3 py-2 bg-primary text-white rounded-lg">Save</button>
      </div>
    </form>
  </div>
</div>

<div id="inv-error" class="text-danger text-sm mt-4 hidden"></div>
{% endblock %}

{% block scripts %}
<script>
const investorId = {{ pk|default:0 }};

// Tabs
function showTab(name){
  ["profile","transactions","documents"].forEach(n=>{
    document.getElementById("tab-"+n).classList.toggle("hidden", n!==name);
  });
}
document.querySelectorAll('[data-tab]').forEach(b=>{
  b.addEventListener('click', ()=>showTab(b.dataset.tab));
});

// CSRF
function getCSRFToken() {
  const m = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
  if (m) return decodeURIComponent(m[1]);
  const meta = document.querySelector('meta[name="csrf-token"]');
  return meta ? meta.content : '';
}

// Fetch helper
async function fetchJSON(url, opts={}){
  const isPostLike = (opts.method || 'GET').toUpperCase() !== 'GET';
  const baseHeaders = {'Content-Type':'application/json'};
  if (isPostLike) baseHeaders['X-CSRFToken'] = getCSRFToken();
  const res = await fetch(url, {credentials:'same-origin', headers:{...baseHeaders, ...(opts.headers||{})}, ...opts});
  if(!res.ok){
    let msg; try { msg = await res.text(); } catch(e){ msg = res.statusText; }
    throw new Error(msg || 'Request failed');
  }
  const ct = res.headers.get('content-type') || '';
  return ct.includes('application/json') ? res.json() : res.text();
}

// Generate Commitment Agreement (DOCX)
async function generateCommitmentAgreement(id){
  try {
    const res = await fetch(`/api/docgen/commitment/${id}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCSRFToken(),
        "Content-Type": "application/json"
      },
      credentials: "same-origin"
    });
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    if (data.file_url) {
      window.open(data.file_url, "_blank"); // open docx in new tab
    } else {
      alert("Agreement generated but file_url missing");
    }
  } catch(err){
    alert("Failed to generate agreement: " + err.message);
  }
}

// Render profile
function renderProfile(inv){
  document.getElementById('pf-name').textContent = inv.name || '—';
  document.getElementById('pf-email').textContent = inv.email || '—';
  document.getElementById('pf-phone').textContent = inv.phone || '—';
  document.getElementById('pf-type').textContent = inv.type || '—';
  document.getElementById('pf-pan').textContent = inv.pan || '—';
  document.getElementById('pf-address').textContent = inv.address || '—';

  const badge = document.getElementById('pf-kyc-badge');
  const completed = !!inv.kyc_completed;
  badge.textContent = completed ? 'COMPLETED' : 'PENDING';
  badge.className = 'px-2 py-1 rounded text-xs ' + (completed ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-600');

  const kyc = inv.kyc || {};
  document.getElementById('pf-kyc-type').textContent = kyc.investor_type || inv.kyc_investor_type || '—';
  document.getElementById('pf-kyc-date').textContent = inv.kyc_date_completed || kyc.date_completed || '—';
  document.getElementById('pf-kyc-notes').textContent = (kyc.notes || '').trim() || '—';
}

// Load investor
async function loadInvestor(){
  try{
    const inv = await fetchJSON(`/api/investors/${investorId}/`);
    document.getElementById('inv-name').textContent = inv.name || "—";
    document.getElementById('inv-email').textContent = inv.email || "—";
    const headerBadge = document.getElementById('inv-kyc');
    const completed = !!inv.kyc_completed;
    headerBadge.textContent = completed ? "COMPLETED" : "PENDING";
    headerBadge.className = "px-2 py-1 rounded text-xs " + (completed ? "bg-green-100 text-green-700" : "bg-red-100 text-red-600");
    renderProfile(inv);
  }catch(err){
    const el = document.getElementById('inv-error');
    el.textContent = "Unable to load investor. " + err.message;
    el.classList.remove('hidden');
  }
}

// Load commitments
async function loadCommitments(){
  try {
    const data = await fetchJSON(`/api/transactions/commitments/?investor=${investorId}`);
    const items = Array.isArray(data) ? data : (data.results || []);
    if (!items.length) return;
    if (document.getElementById("commitments-section")) return;

    const container = document.createElement('div');
    container.id = "commitments-section";
    container.className = "bg-white rounded-xl shadow p-6 mt-6";

    container.innerHTML = `
      <h2 class="text-xl font-semibold mb-4">Fund Commitments</h2>
      <table class="min-w-full bg-white">
        <thead class="bg-gray-100">
          <tr>
            <th class="py-2 px-4 border-b text-left">Fund</th>
            <th class="py-2 px-4 border-b text-right">Committed (INR)</th>
            <th class="py-2 px-4 border-b text-center">Date</th>
            <th class="py-2 px-4 border-b text-center">Agreement</th>
          </tr>
        </thead>
        <tbody id="commit-rows"></tbody>
        <tfoot class="bg-gray-100 font-bold">
          <tr>
            <td class="py-2 px-4 text-left">Total</td>
            <td class="py-2 px-4 text-right" id="commit-total">0.00</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    `;

    document.querySelector("#tab-profile").appendChild(container);

    let total = 0;
    const tbody = container.querySelector("#commit-rows");
    items.forEach(c=>{
      total += parseFloat(c.amount_committed || 0);
      const tr = document.createElement("tr");
      tr.className = "hover:bg-gray-50";
      tr.innerHTML = `
        <td class="py-2 px-4 border-b">
          <a href="/portal/funds/${c.fund}/" class="text-indigo-700 hover:underline">${c.fund_name}</a>
        </td>
        <td class="py-2 px-4 border-b text-right">${parseFloat(c.amount_committed).toFixed(2)}</td>
        <td class="py-2 px-4 border-b text-center">${c.commitment_date}</td>
        <td class="py-2 px-4 border-b text-center">
          <button onclick="generateCommitmentAgreement(${c.id})"
                  class="px-2 py-1 bg-indigo-600 text-white rounded text-xs">
            Generate Agreement
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    container.querySelector("#commit-total").textContent = total.toFixed(2);

  } catch(e) {
    console.error("Failed to load commitments", e);
  }
}

// Init
window.addEventListener('DOMContentLoaded', ()=>{
  showTab('profile');
  loadInvestor();
  loadCommitments();
});
</script>
{% endblock %}
