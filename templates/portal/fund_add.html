{% extends 'base.html' %}
{% block title %}Add Fund • AIF{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">Add Fund</h1>

<form class="bg-white rounded-xl shadow p-6 max-w-3xl space-y-6" onsubmit="return submitFund(event)">
  {% csrf_token %}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Name -->
    <div>
      <label class="block text-sm text-secondary mb-1">Name</label>
      <input name="name" class="w-full border rounded-lg px-3 py-2" required>
    </div>

    <!-- SEBI Registration Number (required) -->
    <div>
      <label class="block text-sm text-secondary mb-1">SEBI Registration Number</label>
      <input name="sebi_registration_number" class="w-full border rounded-lg px-3 py-2" required>
    </div>

    <!-- Category (choices must match model: CAT_I / CAT_II / CAT_III) -->
    <div>
      <label class="block text-sm text-secondary mb-1">Category</label>
      <select name="category" class="w-full border rounded-lg px-3 py-2" required>
        <option value="">Select category…</option>
        <option value="CAT_I">Category I</option>
        <option value="CAT_II">Category II</option>
        <option value="CAT_III">Category III</option>
      </select>
    </div>

    <!-- Corpus -->
    <div>
      <label class="block text-sm text-secondary mb-1">Corpus (₹)</label>
      <input name="corpus" type="number" step="0.01" min="0" class="w-full border rounded-lg px-3 py-2" required>
    </div>

    <!-- Inception Date -->
    <div>
      <label class="block text-sm text-secondary mb-1">Inception Date</label>
      <input name="date_of_inception" type="date" class="w-full border rounded-lg px-3 py-2" required>
    </div>

    <!-- Manager (optional; if you want to select by ID, keep as number; replace with a dropdown later if needed) -->
    <div>
      <label class="block text-sm text-secondary mb-1">Manager (optional, ID)</label>
      <input name="manager" type="number" class="w-full border rounded-lg px-3 py-2" placeholder="Manager Entity ID">
    </div>
  </div>

  <!-- API error bucket -->
  <div id="fund-error" class="text-rose-600 text-sm hidden"></div>

  <div class="mt-2 flex justify-end gap-3">
    <a href="{% url 'funds:portal-funds' %}" class="px-4 py-2 bg-gray-200 rounded-lg">Cancel</a>
    <button class="px-4 py-2 bg-primary hover:bg-indigo-700 text-white rounded-lg">Create Fund</button>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
// --- read csrftoken from cookie (Django standard) ---
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return null;
}
const csrftoken = getCookie('csrftoken');

// --- small fetch helper that includes CSRF + same-origin creds ---
async function api(url, method = 'GET', body = null) {
  const opts = {
    method,
    credentials: 'same-origin',                // send session cookie
    headers: { 'Accept': 'application/json' },
  };
  if (body !== null) {
    opts.headers['Content-Type'] = 'application/json';
    opts.headers['X-CSRFToken'] = csrftoken;   // <— important
    opts.body = JSON.stringify(body);
  }
  const r = await fetch(url, opts);
  if (!r.ok) {
    let msg;
    try { msg = await r.json(); } catch { msg = await r.text(); }
    throw new Error(typeof msg === 'string' ? msg : JSON.stringify(msg));
  }
  return r.json();
}

function collectForm(form) {
  const fd = new FormData(form);
  const payload = Object.fromEntries(fd.entries());
  if (payload.corpus) payload.corpus = String(payload.corpus);
  if (!payload.manager) delete payload.manager;
  return payload;
}

async function submitFund(e) {
  e.preventDefault();
  const errEl = document.getElementById('fund-error');
  errEl.classList.add('hidden'); errEl.textContent = '';

  try {
    const payload = collectForm(e.target);
    const res = await api('/api/funds/', 'POST', payload);
    window.location.href = `/portal/funds/${res.id}/`;
  } catch (err) {
    errEl.textContent = err.message || 'Failed to create fund';
    errEl.classList.remove('hidden');
  }
  return false;
}
</script>
{% endblock %}
