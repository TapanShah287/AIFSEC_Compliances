{% extends "base.html" %}
{% block title %}Investors • AIF{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">Investors</h1>

<div class="mb-4 flex flex-wrap gap-3 items-center">
  <a href="{% url 'portal-investor-onboard' %}" class="px-4 py-2 bg-primary text-white rounded-lg">Onboard Investor</a>
  <input id="search" placeholder="Search name/email..." class="border rounded-lg px-3 py-2 w-72">
</div>

<div class="bg-white rounded-xl shadow overflow-hidden">
  <table class="w-full text-sm">
    <thead class="bg-gray-50">
      <tr>
        <th class="text-left px-4 py-2">Name</th>
        <th class="text-left px-4 py-2">Email</th>
        <th class="text-left px-4 py-2">Type</th>
        <th class="text-left px-4 py-2">KYC</th>
        <th class="text-right px-4 py-2"></th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<div id="empty" class="text-secondary text-sm mt-4 hidden">No investors found.</div>
<div id="error" class="text-danger text-sm mt-4 hidden"></div>
{% endblock %}

{% block scripts %}
<script>
function getCSRFToken() {
  const m = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
  if (m) return decodeURIComponent(m[1]);
  const meta = document.querySelector('meta[name="csrf-token"]');
  return meta ? meta.content : '';
}

async function fetchJSON(url, opts={}){
  const res = await fetch(url, {credentials:'same-origin', headers:{'Content-Type':'application/json', ...(opts.headers||{})}, ...opts});
  if(!res.ok){ throw new Error((await res.text()) || res.statusText); }
  return res.json();
}

function kycBadge(completed){
  const yes = !!completed;
  const cls = yes ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-600';
  const txt = yes ? 'COMPLETED' : 'PENDING';
  return `<span class="px-2 py-1 rounded text-xs ${cls}">${txt}</span>`;
}

function renderRows(items){
  const tbody = document.getElementById('rows');
  tbody.innerHTML = '';
  if(!items.length){
    document.getElementById('empty').classList.remove('hidden');
    return;
  }
  document.getElementById('empty').classList.add('hidden');

  items.forEach(inv=>{
    const tr = document.createElement('tr');
    tr.className = "border-t";
    tr.innerHTML = `
      <td class="px-4 py-2">${inv.name || '—'}</td>
      <td class="px-4 py-2">${inv.email || '—'}</td>
      <td class="px-4 py-2">${inv.type || '—'}</td>
      <td class="px-4 py-2">${kycBadge(inv.kyc_completed)}</td>
      <td class="px-4 py-2 text-right">
        <a class="px-3 py-1 rounded bg-gray-200" href="/portal/investors/${inv.id}/">View</a>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

let allItems = [];
async function loadInvestors(q=""){
  try{
    const url = q ? `/api/investors/?search=${encodeURIComponent(q)}` : `/api/investors/`;
    const data = await fetchJSON(url);
    // Handle both paginated and plain arrays
    allItems = Array.isArray(data) ? data : (data.results || []);
    // Expect unified field from API: kyc_completed (bool)
    renderRows(allItems);
  }catch(err){
    const el = document.getElementById('error');
    el.textContent = "Failed to load investors: " + err.message;
    el.classList.remove('hidden');
  }
}

document.getElementById('search').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  if(!q) return renderRows(allItems);
  const filtered = allItems.filter(x =>
    (x.name||'').toLowerCase().includes(q) ||
    (x.email||'').toLowerCase().includes(q)
  );
  renderRows(filtered);
});

window.addEventListener('DOMContentLoaded', ()=> loadInvestors());
</script>
{% endblock %}
